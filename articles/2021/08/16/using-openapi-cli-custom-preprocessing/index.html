<!doctype html><html lang=en prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# profile: http://ogp.me/ns/profile#"><head><title>aviskase</title><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><meta property="og:title" content="Using openapi-cli: custom preprocessing"><meta property="og:description" content="The key feature of openapi-cli is its extensibility. There are three ways to extend it: preprocessors, rules, and decorators. In comparison, Spectral supports only custom rules.
In this tutorial, we&rsquo;ll start with preprocessors. They are used to transform OpenAPI description document before validation and linting. Mind you, documentation says they should be avoided, because custom preprocessors tend to be error prone."><meta name=description content="The key feature of openapi-cli is its extensibility. There are three ways to extend it: preprocessors, rules, and decorators. In comparison, Spectral supports only custom rules.
In this tutorial, we&rsquo;ll start with preprocessors. They are used to transform OpenAPI description document before validation and linting. Mind you, documentation says they should be avoided, because custom preprocessors tend to be error prone."><meta property="og:url" content="https://www.aviskase.com/articles/2021/08/16/using-openapi-cli-custom-preprocessing/"><link rel=canonical href=https://www.aviskase.com/articles/2021/08/16/using-openapi-cli-custom-preprocessing/><meta property="og:type" content="article"><meta property="og:image" content="https://www.aviskase.com/articles/2021/08/16/using-openapi-cli-custom-preprocessing/feature.png"><meta property="og:image:height" content="630"><meta property="og:image:width" content="1200"><meta property="article:published_time" content="2021-08-16T23:44:37-04:00"><meta property="article:modified_time" content="2021-08-16T23:44:37-04:00"><meta property="og:site_name" content="aviskase"><meta property="article:author" content="https://www.aviskase.com/pages/about/"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.aviskase.com/articles/2021/08/16/using-openapi-cli-custom-preprocessing/feature.png"><meta name=twitter:title content="Using `openapi-cli`: custom preprocessing"><meta name=twitter:description content="The key feature of openapi-cli is its extensibility. There are three ways to extend it: preprocessors, rules, and decorators. In comparison, Spectral supports only custom rules.
In this tutorial, we&rsquo;ll start with preprocessors. They are used to transform OpenAPI description document before validation and linting. Mind you, documentation says they should be avoided, because custom preprocessors tend to be error prone."><meta name=twitter:site content="@aviskase"><meta name=generator content="Hugo 0.83.1"><link rel=stylesheet href=/css/main.min.2fd237831c1d0b67afc11b740de349fe3fdc59f7f440bc19494cc2ab2ae2e61c.css integrity=sha256-L9I3gxwdC2evwRt0DeNJ/j/cWff0QLwZSUzCqyri5hw=></head><body><div class="min-h-screen grid grid-rows-mainLayout"><header><nav class="bg-gradient-to-b from-bgdark to-bglight relative lowercase"><div class="pb-12 pt-6 max-w-normal flex flex-wrap items-center normal:items-baseline justify-between mx-6 normal:mx-auto"><a class="text-primary font-bold text-24" href=/>aviskase</a>
<input id=nav-toggle type=checkbox>
<label id=show-button for=nav-toggle class="flex items-center normal:hidden"><svg class="h-8 w-8" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><title>Menu Open</title><path d="M0 3h20v2H0V3zm0 6h20v2H0V9zm0 6h20v2H0V0z"/></svg></label><label id=hide-button for=nav-toggle class="items-center hidden"><svg class="h-8 w-8" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><title>Menu Close</title><polygon points="11 9 22 9 22 11 11 11 11 22 9 22 9 11 -2 11 -2 9 9 9 9 -2 11 -2" transform="rotate(45 10 10)"/></svg></label><ul id=nav-menu class="font-semibold text-16 hidden normal:flex mt-3 normal:mt-0 space-y-3 normal:space-y-0 normal:space-x-4.5 w-full normal:w-auto"><li><a href=/>Home</a></li><li><a href=/pages/about/>About</a></li><li><a href=/pages/archive/>Archive</a></li><li><a href=/feeds/all.atom.xml>RSS</a></li></ul></div><div class=shape-divider><svg data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 120" preserveAspectRatio="none"><path d="M0 0V46.29c47.79 22.2 103.59 32.17 158 28 70.36-5.37 136.33-33.31 206.8-37.5C438.64 32.43 512.34 53.67 583 72.05c69.27 18 138.3 24.88 209.4 13.08 36.15-6 69.85-17.84 104.45-29.34C989.49 25 1113-14.29 12e2 52.47V0z" opacity=".25" class="shape-fill"/><path d="M0 0V15.81C13 36.92 27.64 56.86 47.69 72.05 99.41 111.27 165 111 224.58 91.58c31.15-10.15 60.09-26.07 89.67-39.8 40.92-19 84.73-46 130.83-49.67 36.26-2.85 70.9 9.42 98.6 31.56 31.77 25.39 62.32 62 103.63 73 40.44 10.79 81.35-6.69 119.13-24.28s75.16-39 116.92-43.05c59.73-5.85 113.28 22.88 168.9 38.84 30.2 8.66 59 6.17 87.09-7.5 22.43-10.89 48-26.93 60.65-49.24V0z" opacity=".5" class="shape-fill"/><path d="M0 0V5.63C149.93 59 314.09 71.32 475.83 42.57c43-7.64 84.23-20.12 127.61-26.46 59-8.63 112.48 12.24 165.56 35.4C827.93 77.22 886 95.24 951.2 90c86.53-7 172.46-45.71 248.8-84.81V0z" class="shape-fill"/></svg></div></nav></header><main><div class=title-hero><h1>Using <code>openapi-cli</code>: custom preprocessing</h1><div class=article-meta><div class=normal:justify-self-end>16 Aug 2021</div><div class="hidden normal:block">&nbsp;â€”&nbsp;</div><div class="relative normal:justify-self-start"><svg class="inline relative" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg><span>&nbsp;3&nbsp;mins</span></div></div></div><article><p>The key feature of <code>openapi-cli</code> is its extensibility. There are three ways to extend it: <a href=https://redoc.ly/docs/cli/custom-rules/ class=external>preprocessors, rules, and decorators</a>. In comparison, <a href=https://meta.stoplight.io/docs/spectral class=external>Spectral</a> supports only custom rules.</p><p>In this tutorial, we&rsquo;ll start with <strong>preprocessors</strong>. They are used to transform OpenAPI description document <em>before</em> validation and linting. Mind you, documentation says they should be avoided, because custom preprocessors tend to be error prone.</p><div class="relative header-wrapper"><h2 id=example-extensible-enumerations><a href=#example-extensible-enumerations class=header-link><svg xmlns="http://www.w3.org/2000/svg" style="display:inline-block;vertical-align:middle" width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg></a>Example: extensible enumerations</h2></div><p>In our Stargate Network API there is a <a href=https://github.com/aviskase/openapi-cli-examples/blob/bb95d479cc184221b38ff5d5371767f0b3f32f74/openapi/components/schemas/Stargate.yaml class=external><code>Stargate.yaml</code> schema</a> with two properties defined with enumerations: <code>state</code> and <code>environment</code>. We might think that we captured all potential values, but we can&rsquo;t be sure.</p><p><a href=https://opensource.zalando.com/restful-api-guidelines/#112 class=external>Zalando API guidelines</a> and <a href=https://livebook.manning.com/book/the-design-of-web-apis/chapter-9/table9.1 class=external>The Design of Web APIs by Arnaud Lauret</a> warn us that enumerations can cause API compatibility breaks, especially with outputs.</p><p>Imagine the scenario. We generated SDK for the initial version of the API, and the generator was smart enough to use enumerations in the selected programming language. Some time later we push a new API version where <code>environment</code> can also be <code>STAR</code>. Customers, who are still on the first version of the SDK, won&rsquo;t be able to process API responses containing this value, because most probably their clients will crash with something-something-uprocessable-entity exceptions.</p><p>Thus, similarly to Zalando, we will use a custom <a href=https://spec.openapis.org/oas/v3.0.3.html#specification-extensions class=external>vendor extension</a> to document possible values. I&rsquo;m calling it <code>x-aviskase-enum</code> just in case not to introduce conflicts with other extensions. <a href=https://github.com/aviskase/openapi-cli-examples/tree/fa78766d7ea2cd245740373efb951bffe7b2facf class=external>Commit fa78766</a>.</p><div class="relative header-wrapper"><h2 id=surfacing-values-in-the-documentation><a href=#surfacing-values-in-the-documentation class=header-link><svg xmlns="http://www.w3.org/2000/svg" style="display:inline-block;vertical-align:middle" width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg></a>Surfacing values in the documentation</h2></div><p>Oops, now there is no way to see known values in the generated reference docs. The manual fix is to add these values to the <code>description</code>. But this is too cumbersome, especially if you&rsquo;ll ever want to change presentation format.</p><p>Preprocessor for the rescue! What we want it to do:</p><ol><li>Find all properties with <code>x-aviskase-enum</code> property.</li><li>Grab the list of values, format them nicely, and add it to the <code>description</code>. Make sure not to overwrite existing description if it&rsquo;s already present!</li></ol><div class="relative header-wrapper"><h3 id=adding-a-preprocessor><a href=#adding-a-preprocessor class=header-link><svg xmlns="http://www.w3.org/2000/svg" style="display:inline-block;vertical-align:middle" width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg></a>Adding a preprocessor</h3></div><p>Let&rsquo;s create a preprocessor first <code>./plugins/preprocessors/add-enum-to-description.js</code>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#6272a4>//@ts-check
</span><span style=color:#6272a4></span>module.exports <span style=color:#ff79c6>=</span> AddEnumToDescription;

<span style=color:#6272a4>/** @type { import(&#39;@redocly/openapi-core/src/visitors&#39;).Oas3Preprocessor } */</span>
<span style=color:#8be9fd;font-style:italic>function</span> AddEnumToDescription(options) {
  <span style=color:#ff79c6>const</span> vendorExtension <span style=color:#ff79c6>=</span> options.vendorExtension <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39;x-enum&#39;</span>;
  <span style=color:#ff79c6>return</span> {
    Schema(schema) {
      <span style=color:#ff79c6>if</span> (schema[vendorExtension]) {
        schema.description <span style=color:#ff79c6>=</span> appendToDescription(schema[vendorExtension], schema.description);
      }
    },
  };
}

<span style=color:#8be9fd;font-style:italic>function</span> appendToDescription(values, description) {
  <span style=color:#8be9fd;font-style:italic>let</span> additionalDescription <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>`Possible values: </span><span style=color:#f1fa8c>${</span>values.map(v =&gt; <span style=color:#f1fa8c>`\`</span><span style=color:#f1fa8c>${</span>v<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>\``</span>).join(<span style=color:#f1fa8c>&#39;, &#39;</span>)<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>`</span>;
  <span style=color:#ff79c6>if</span> (description) {
    <span style=color:#ff79c6>return</span> <span style=color:#f1fa8c>`</span><span style=color:#f1fa8c>${</span>description<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>\n\n</span><span style=color:#f1fa8c>${</span>additionalDescription<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>`</span>;
  }
  <span style=color:#ff79c6>return</span> additionalDescription;
}

</code></pre></div><p>What&rsquo;s happening here:</p><ul><li>We export a preprocessor function <code>AddEnumToDescription</code> that accepts configuration <code>options</code>:<ul><li><code>vendorExtension</code> option is used to define extension name for extensible enumeration. If not provided, it equals to <code>x-enum</code>.</li></ul></li><li>All <code>openapi-cli</code> preprocessors should return a <em>visitor</em>. In our case, we specifically indicate to take into account only schema nodes.</li><li>If a schema has defined extensible enumeration property, we update its description with formatted list of values.</li></ul><div class="admonition warning"><div class=admonition-icon><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg></div><p>Per documentation, for type support you can use <code>import('@redocly/openapi-cli').Oas3Preprocessor}</code>. It never worked for me, so I use a &ldquo;full path&rdquo; <code>import('@redocly/openapi-core/src/visitors').Oas3Preprocessor</code>.</p></div><div class="relative header-wrapper"><h3 id=enabling-our-preprocessor-via-custom-plugin><a href=#enabling-our-preprocessor-via-custom-plugin class=header-link><svg xmlns="http://www.w3.org/2000/svg" style="display:inline-block;vertical-align:middle" width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg></a>Enabling our preprocessor via custom plugin</h3></div><p>Let&rsquo;s keep our preprocessor (and the future ones) bundled inside one plugin via <code>./plugins/custom-preprocessors.js</code>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#6272a4>//@ts-check
</span><span style=color:#6272a4></span><span style=color:#ff79c6>const</span> AddEnumToDescription <span style=color:#ff79c6>=</span> require(<span style=color:#f1fa8c>&#39;./preprocessors/add-enum-to-description&#39;</span>);
<span style=color:#ff79c6>const</span> id <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;custom-preprocessors&#39;</span>;

<span style=color:#6272a4>/** @type { import(&#39;@redocly/openapi-core/src/config/config&#39;).PreprocessorsConfig } */</span>
<span style=color:#ff79c6>const</span> preprocessors <span style=color:#ff79c6>=</span> {
  oas3<span style=color:#ff79c6>:</span> {
    <span style=color:#f1fa8c>&#39;add-x-enum-to-description&#39;</span><span style=color:#ff79c6>:</span> AddEnumToDescription,
  },
};

module.exports <span style=color:#ff79c6>=</span> {
  id,
  preprocessors,
};
</code></pre></div><p>Here we defined plugin&rsquo;s <code>id</code> and a mapping between preprocessor&rsquo;s name (<code>add-x-enum-to-description</code>) and its implementation.</p><p>Then we need to add this custom plugin to the <code>.redocly.yaml</code> and to enable the preprocessor:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>...
<span style=color:#ff79c6>lint</span>:
  <span style=color:#ff79c6>plugins</span>:
    - <span style=color:#f1fa8c>&#39;./plugins/custom-preprocessors.js&#39;</span>
  <span style=color:#ff79c6>preprocessors</span>:
    <span style=color:#ff79c6>custom-preprocessors/add-x-enum-to-description</span>:
      <span style=color:#ff79c6>vendorExtension</span>: x-aviskase-enum
...
</code></pre></div><p>The final result is in <a href=https://github.com/aviskase/openapi-cli-examples/tree/665492641fa119292d2ef7aa2c6bd4a87266ff9b class=external>commit 6654926</a>.</p><div class="relative header-wrapper"><h2 id=how-it-looks-in-the-docs><a href=#how-it-looks-in-the-docs class=header-link><svg xmlns="http://www.w3.org/2000/svg" style="display:inline-block;vertical-align:middle" width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg></a>How it looks in the docs</h2></div><p>Now, when we render a reference documentation, we can see all values with simple markdown formatting.</p><p><figure><picture><source srcset=https://www.aviskase.com/articles/2021/08/16/using-openapi-cli-custom-preprocessing/x_enum_render_hu0c23a21c68146543c289aaa72aeaae18_43182_1445x324_resize_q75_h2_box_2.webp type=image/webp><img src=https://www.aviskase.com/articles/2021/08/16/using-openapi-cli-custom-preprocessing/x_enum_render.png alt="Redoc with modified descriptions for extensible enumerations" defer></picture></figure></p><div class="admonition cta"><div class=admonition-icon><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636-.707.707M21 12h-1M4 12H3m3.343-5.657-.707-.707m2.828 9.9a5 5 0 117.072.0l-.548.547A3.374 3.374.0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg></div><p>By the way, can you spot operations where we could have left normal <code>enum</code> and why?</p></div><div class="relative header-wrapper"><h2 id=why-use-a-preprocessor-here><a href=#why-use-a-preprocessor-here class=header-link><svg xmlns="http://www.w3.org/2000/svg" style="display:inline-block;vertical-align:middle" width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg></a>Why use a preprocessor here?</h2></div><p>As mentioned before, preprocessors might be brittle. We could have used decorator instead. I&rsquo;ll show you the reason in the next article, but here is a sneak peek: we want to be able to <em>lint</em> modified descriptions!</p></article><div class=page-navigation><a class=prev href=https://www.aviskase.com/articles/2021/03/23/using-openapi-cli-during-api-design-part-two/ title="Using `openapi-cli` during API design: part two"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 17l-5-5 5-5m7 10-5-5 5-5"/></svg>older</a></div></main><footer class="justify-center flex w-full py-4 text-16"><a class="border-b-2 border-transparent hover:border-primary" href=mailto:aviskase@gmail.com>Yuliya Bagriy</a><span> &#183; 2021 &#183; </span><a class="border-b-2 border-transparent hover:border-primary" href=https://www.aviskase.com/pages/i-dont-track-you/>No tracking</a></footer></div></body></html>