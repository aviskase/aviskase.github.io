<!doctype html><html lang=en prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# profile: http://ogp.me/ns/profile#"><head><base href=https://www.aviskase.com/articles/2021/08/16/using-openapi-cli-custom-preprocessing/><title>Using openapi-cli: custom preprocessing | aviskase</title>
<meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><meta property="og:title" content="Using openapi-cli: custom preprocessing"><meta name=twitter:title content="Using openapi-cli: custom preprocessing"><meta property="og:description" content="The key feature of openapi-cli is its extensibility. There are three ways to extend it: preprocessors, rules, and decorators. In comparison, Spectral supports only custom rules.
In this tutorial, we&rsquo;ll start with preprocessors. They are used to transform OpenAPI description document before validation and linting. Mind you, documentation says they should be avoided, because custom preprocessors tend to be error prone."><meta property="twitter:description" content="The key feature of openapi-cli is its extensibility. There are three ways to extend it: preprocessors, rules, and decorators. In comparison, Spectral supports only custom rules.
In this tutorial, we&rsquo;ll start with preprocessors. They are used to transform OpenAPI description document before validation and linting. Mind you, documentation says they should be avoided, because custom preprocessors tend to be error prone."><meta name=description content="The key feature of openapi-cli is its extensibility. There are three ways to extend it: preprocessors, rules, and decorators. In comparison, Spectral supports only custom rules.
In this tutorial, we&rsquo;ll start with preprocessors. They are used to transform OpenAPI description document before validation and linting. Mind you, documentation says they should be avoided, because custom preprocessors tend to be error prone."><meta property="og:url" content="https://www.aviskase.com/articles/2021/08/16/using-openapi-cli-custom-preprocessing/"><link rel=canonical href=https://www.aviskase.com/articles/2021/08/16/using-openapi-cli-custom-preprocessing/><meta property="og:type" content="article"><meta property="article:published_time" content="2021-08-16T23:44:37-04:00"><meta property="article:modified_time" content="2021-08-16T23:44:37-04:00"><meta property="og:site_name" content="aviskase"><meta property="article:author" content="https://www.aviskase.com/pages/about/"><meta name=twitter:card content="summary"><meta name=twitter:creator content="@aviskase"><link rel=me href=https://infosec.exchange/@aviskase><meta name=fediverse:creator content="@aviskase@infosec.exchange"><meta name=generator content="Hugo 0.142.0"><link rel=stylesheet href=/css/main.min.e31a2bbd829081f48fc8d09ed8511092a1975a73edaf3f95840163d9b8bcd14b.css integrity="sha256-4xorvYKQgfSPyNCe2FEQkqGXWnPtrz+VhAFj2bi80Us="><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest></head><body><header><a href=/ class=title>aviskase</a><p><a href=/>Home</a>
<a href=/pages/about/>About</a>
<a href=/pages/archive/>Archive</a>
<a href=/feeds/all.atom.xml>RSS</a></p></header><main><div class=title><h1>Using <code>openapi-cli</code>: custom preprocessing</h1></div><table class=article-props><tr><th class=width-min>published</th><td class=width-auto>2021-08-08</td></tr><tr><th class=width-min>reading&nbsp;time</th><td class=width-auto>4&nbsp;mins</td></tr></table><article><p>The key feature of <code>openapi-cli</code> is its extensibility. There are three ways to extend it: <a href=https://redoc.ly/docs/cli/custom-rules/ class=external-link>preprocessors, rules, and decorators</a>. In comparison, <a href=https://meta.stoplight.io/docs/spectral class=external-link>Spectral</a> supports only custom rules.</p><p>In this tutorial, we&rsquo;ll start with <strong>preprocessors</strong>. They are used to transform OpenAPI description document <em>before</em> validation and linting. Mind you, documentation says they should be avoided, because custom preprocessors tend to be error prone.</p><h2 id=example-extensible-enumerations><a href=#example-extensible-enumerations>Example: extensible enumerations</a></h2><p>In our Stargate Network API there is a <a href=https://github.com/aviskase/openapi-cli-examples/blob/bb95d479cc184221b38ff5d5371767f0b3f32f74/openapi/components/schemas/Stargate.yaml class=external-link><code>Stargate.yaml</code> schema</a> with two properties defined with enumerations: <code>state</code> and <code>environment</code>. We might think that we captured all potential values, but we can&rsquo;t be sure.</p><p><a href=https://opensource.zalando.com/restful-api-guidelines/#112 class=external-link>Zalando API guidelines</a> and <a href=https://livebook.manning.com/book/the-design-of-web-apis/chapter-9/table9.1 class=external-link>The Design of Web APIs by Arnaud Lauret</a> warn us that enumerations can cause API compatibility breaks, especially with outputs.</p><p>Imagine the scenario. We generated SDK for the initial version of the API, and the generator was smart enough to use enumerations in the selected programming language. Some time later we push a new API version where <code>environment</code> can also be <code>STAR</code>. Customers, who are still on the first version of the SDK, won&rsquo;t be able to process API responses containing this value, because most probably their clients will crash with something-something-uprocessable-entity exceptions.</p><p>Thus, similarly to Zalando, we will use a custom <a href=https://spec.openapis.org/oas/v3.0.3.html#specification-extensions class=external-link>vendor extension</a> to document possible values. I&rsquo;m calling it <code>x-aviskase-enum</code> just in case not to introduce conflicts with other extensions. <a href=https://github.com/aviskase/openapi-cli-examples/tree/fa78766d7ea2cd245740373efb951bffe7b2facf class=external-link>Commit fa78766</a>.</p><h2 id=surfacing-values-in-the-documentation><a href=#surfacing-values-in-the-documentation>Surfacing values in the documentation</a></h2><p>Oops, now there is no way to see known values in the generated reference docs. The manual fix is to add these values to the <code>description</code>. But this is too cumbersome, especially if you&rsquo;ll ever want to change presentation format.</p><p>Preprocessor for the rescue! What we want it to do:</p><ol><li>Find all properties with <code>x-aviskase-enum</code> property.</li><li>Grab the list of values, format them nicely, and add it to the <code>description</code>. Make sure not to overwrite existing description if it&rsquo;s already present!</li></ol><h3 id=adding-a-preprocessor><a href=#adding-a-preprocessor>Adding a preprocessor</a></h3><p>Let&rsquo;s create a preprocessor first <code>./plugins/preprocessors/add-enum-to-description.js</code>:</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#6c7086;font-style:italic>//@ts-check
</span></span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic></span>module.exports <span style=color:#89dceb;font-weight:700>=</span> AddEnumToDescription;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic>/** @type { import(&#39;@redocly/openapi-core/src/visitors&#39;).Oas3Preprocessor } */</span>
</span></span><span style=display:flex><span><span style=color:#f38ba8>function</span> AddEnumToDescription(options) {
</span></span><span style=display:flex><span>  <span style=color:#cba6f7>const</span> vendorExtension <span style=color:#89dceb;font-weight:700>=</span> options.vendorExtension <span style=color:#89dceb;font-weight:700>||</span> <span style=color:#a6e3a1>&#39;x-enum&#39;</span>;
</span></span><span style=display:flex><span>  <span style=color:#cba6f7>return</span> {
</span></span><span style=display:flex><span>    Schema(schema) {
</span></span><span style=display:flex><span>      <span style=color:#cba6f7>if</span> (schema[vendorExtension]) {
</span></span><span style=display:flex><span>        schema.description <span style=color:#89dceb;font-weight:700>=</span> appendToDescription(schema[vendorExtension], schema.description);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f38ba8>function</span> appendToDescription(values, description) {
</span></span><span style=display:flex><span>  <span style=color:#f38ba8>let</span> additionalDescription <span style=color:#89dceb;font-weight:700>=</span> <span style=color:#a6e3a1>`Possible values: </span><span style=color:#a6e3a1>${</span>values.map(v =&gt; <span style=color:#a6e3a1>`\`</span><span style=color:#a6e3a1>${</span>v<span style=color:#a6e3a1>}</span><span style=color:#a6e3a1>\``</span>).join(<span style=color:#a6e3a1>&#39;, &#39;</span>)<span style=color:#a6e3a1>}</span><span style=color:#a6e3a1>`</span>;
</span></span><span style=display:flex><span>  <span style=color:#cba6f7>if</span> (description) {
</span></span><span style=display:flex><span>    <span style=color:#cba6f7>return</span> <span style=color:#a6e3a1>`</span><span style=color:#a6e3a1>${</span>description<span style=color:#a6e3a1>}</span><span style=color:#a6e3a1>\n\n</span><span style=color:#a6e3a1>${</span>additionalDescription<span style=color:#a6e3a1>}</span><span style=color:#a6e3a1>`</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#cba6f7>return</span> additionalDescription;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>What&rsquo;s happening here:</p><ul><li>We export a preprocessor function <code>AddEnumToDescription</code> that accepts configuration <code>options</code>:<ul><li><code>vendorExtension</code> option is used to define extension name for extensible enumeration. If not provided, it equals to <code>x-enum</code>.</li></ul></li><li>All <code>openapi-cli</code> preprocessors should return a <em>visitor</em>. In our case, we specifically indicate to take into account only schema nodes.</li><li>If a schema has defined extensible enumeration property, we update its description with formatted list of values.</li></ul><div class="callout warning"><p>Per documentation, for type support you can use <code>import('@redocly/openapi-cli').Oas3Preprocessor}</code>. It never worked for me, so I use a &ldquo;full path&rdquo; <code>import('@redocly/openapi-core/src/visitors').Oas3Preprocessor</code>.</p></div><h3 id=enabling-our-preprocessor-via-custom-plugin><a href=#enabling-our-preprocessor-via-custom-plugin>Enabling our preprocessor via custom plugin</a></h3><p>Let&rsquo;s keep our preprocessor (and the future ones) bundled inside one plugin via <code>./plugins/custom-preprocessors.js</code>:</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#6c7086;font-style:italic>//@ts-check
</span></span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic></span><span style=color:#cba6f7>const</span> AddEnumToDescription <span style=color:#89dceb;font-weight:700>=</span> require(<span style=color:#a6e3a1>&#39;./preprocessors/add-enum-to-description&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#cba6f7>const</span> id <span style=color:#89dceb;font-weight:700>=</span> <span style=color:#a6e3a1>&#39;custom-preprocessors&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6c7086;font-style:italic>/** @type { import(&#39;@redocly/openapi-core/src/config/config&#39;).PreprocessorsConfig } */</span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>const</span> preprocessors <span style=color:#89dceb;font-weight:700>=</span> {
</span></span><span style=display:flex><span>  oas3<span style=color:#89dceb;font-weight:700>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e3a1>&#39;add-x-enum-to-description&#39;</span><span style=color:#89dceb;font-weight:700>:</span> AddEnumToDescription,
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>module.exports <span style=color:#89dceb;font-weight:700>=</span> {
</span></span><span style=display:flex><span>  id,
</span></span><span style=display:flex><span>  preprocessors,
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>Here we defined plugin&rsquo;s <code>id</code> and a mapping between preprocessor&rsquo;s name (<code>add-x-enum-to-description</code>) and its implementation.</p><p>Then we need to add this custom plugin to the <code>.redocly.yaml</code> and to enable the preprocessor:</p><div class=highlight><pre tabindex=0 style=color:#cdd6f4;background-color:#1e1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#fab387>...</span>
</span></span><span style=display:flex><span><span style=color:#cba6f7>lint</span>:
</span></span><span style=display:flex><span>  <span style=color:#cba6f7>plugins</span>:
</span></span><span style=display:flex><span>    - <span style=color:#a6e3a1>&#39;./plugins/custom-preprocessors.js&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#cba6f7>preprocessors</span>:
</span></span><span style=display:flex><span>    <span style=color:#cba6f7>custom-preprocessors/add-x-enum-to-description</span>:
</span></span><span style=display:flex><span>      <span style=color:#cba6f7>vendorExtension</span>: x-aviskase-enum
</span></span><span style=display:flex><span><span style=color:#fab387>...</span>
</span></span></code></pre></div><p>The final result is in <a href=https://github.com/aviskase/openapi-cli-examples/tree/665492641fa119292d2ef7aa2c6bd4a87266ff9b class=external-link>commit 6654926</a>.</p><h2 id=how-it-looks-in-the-docs><a href=#how-it-looks-in-the-docs>How it looks in the docs</a></h2><p>Now, when we render a reference documentation, we can see all values with simple markdown formatting.</p><p><figure><picture><source srcset=https://www.aviskase.com/articles/2021/08/16/using-openapi-cli-custom-preprocessing/x_enum_render_hu_78bb03db39baa63b.webp type=image/webp><img class="mx-auto rounded" src=https://www.aviskase.com/articles/2021/08/16/using-openapi-cli-custom-preprocessing/x_enum_render.png alt="Redoc with modified descriptions for extensible enumerations" defer></picture></figure></p><div class="callout cta"><p>By the way, can you spot operations where we could have left normal <code>enum</code> and why?</p></div><h2 id=why-use-a-preprocessor-here><a href=#why-use-a-preprocessor-here>Why use a preprocessor here?</a></h2><p>As mentioned before, preprocessors might be brittle. We could have used decorator instead. I&rsquo;ll show you the reason in the next article, but here is a sneak peek: we want to be able to <a href=https://www.aviskase.com/articles/2021/09/06/using-openapi-cli-custom-rules/ class=internal-link><em>lint</em> modified descriptions</a>!</p></article><div class=article-nav><span class=article-nav-old><a href=https://www.aviskase.com/articles/2021/03/23/using-openapi-cli-during-api-design-part-two/ title="Using openapi-cli during API design: part two"><span class=arrow>◁</span>older</a>
</span><span class=article-nav-middle>&nbsp;&#183;&nbsp;&#183;&nbsp;&#183;&nbsp;</span>
<span class=article-nav-new><a href=https://www.aviskase.com/articles/2021/09/06/using-openapi-cli-custom-rules/ title="Using openapi-cli: custom rules">newer<span class=arrow>▶</span></a></span></div></main><footer><span>2025&nbsp;&#183;&nbsp;</span><a href=mailto:aviskase@gmail.com>Yuliya Bagriy</a><a href=https://www.aviskase.com/pages/i-dont-track-you/>&nbsp;&#183;&nbsp;No tracking</a></footer></body></html>