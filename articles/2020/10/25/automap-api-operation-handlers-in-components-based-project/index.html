<!doctype html><html lang=en prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# profile: http://ogp.me/ns/profile#"><head><title>aviskase</title><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><meta property="og:title" content="Automap API Operation Handlers in Components-Based Project"><meta property="og:description" content="Node.js best practices repo is the most comprehensive list of style guides and architectural tips for Node.js apps I&rsquo;ve seen. The very first of them is about structuring projects based on components instead of layers.
For example, the typical layers-based layout would be:
. ├── common │ └── utils.ts ├── routers │ ├── locations."><meta name=description content="Node.js best practices repo is the most comprehensive list of style guides and architectural tips for Node.js apps I&rsquo;ve seen. The very first of them is about structuring projects based on components instead of layers.
For example, the typical layers-based layout would be:
. ├── common │ └── utils.ts ├── routers │ ├── locations."><meta property="og:url" content="https://www.aviskase.com/articles/2020/10/25/automap-api-operation-handlers-in-components-based-project/"><link rel=canonical href=https://www.aviskase.com/articles/2020/10/25/automap-api-operation-handlers-in-components-based-project/><meta property="og:type" content="article"><meta property="og:image" content="https://www.aviskase.com/articles/2020/10/25/automap-api-operation-handlers-in-components-based-project/feature.png"><meta property="og:image:height" content="630"><meta property="og:image:width" content="1200"><meta property="article:published_time" content="2020-10-25T22:05:10-04:00"><meta property="article:modified_time" content="2020-10-28T23:10:10-04:00"><meta property="og:site_name" content="aviskase"><meta property="article:author" content="https://www.aviskase.com/pages/about/"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.aviskase.com/articles/2020/10/25/automap-api-operation-handlers-in-components-based-project/feature.png"><meta name=twitter:title content="Automap API Operation Handlers in Components-Based Project"><meta name=twitter:description content="Node.js best practices repo is the most comprehensive list of style guides and architectural tips for Node.js apps I&rsquo;ve seen. The very first of them is about structuring projects based on components instead of layers.
For example, the typical layers-based layout would be:
. ├── common │ └── utils.ts ├── routers │ ├── locations."><meta name=twitter:site content="@aviskase"><meta name=generator content="Hugo 0.78.0"><link rel=stylesheet href=/css/main.min.36f5e36c79449eb58a13d805699aa5e31eaf640489e76d2340f7bc1919571159.css integrity=sha256-NvXjbHlEnrWKE9gFaZql4x6vZASJ520jQPe8GRlXEVk=></head><body><div class="min-h-screen grid grid-rows-mainLayout"><header><nav class="bg-gradient-to-b from-bgdark to-bglight relative lowercase"><div class="pb-12 pt-6 max-w-normal flex flex-wrap items-center normal:items-baseline justify-between mx-6 normal:mx-auto"><a class="text-primary font-bold text-24" href=/>aviskase</a>
<input id=nav-toggle type=checkbox>
<label id=show-button for=nav-toggle class="flex items-center normal:hidden"><svg class="h-8 w-8" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><title>Menu Open</title><path d="M0 3h20v2H0V3zm0 6h20v2H0V9zm0 6h20v2H0V0z"/></svg></label><label id=hide-button for=nav-toggle class="items-center hidden"><svg class="h-8 w-8" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><title>Menu Close</title><polygon points="11 9 22 9 22 11 11 11 11 22 9 22 9 11 -2 11 -2 9 9 9 9 -2 11 -2" transform="rotate(45 10 10)"/></svg></label><ul id=nav-menu class="font-semibold text-16 hidden normal:flex mt-3 normal:mt-0 space-y-3 normal:space-y-0 normal:space-x-4.5 w-full normal:w-auto"><li><a href=/>Blog</a></li><li><a href=/pages/about/>About</a></li><li><a href=/feeds/all.atom.xml>RSS</a></li></ul></div><div class=shape-divider><svg data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 120" preserveAspectRatio="none"><path d="M0 0V46.29c47.79 22.2 103.59 32.17 158 28 70.36-5.37 136.33-33.31 206.8-37.5C438.64 32.43 512.34 53.67 583 72.05c69.27 18 138.3 24.88 209.4 13.08 36.15-6 69.85-17.84 104.45-29.34C989.49 25 1113-14.29 12e2 52.47V0z" opacity=".25" class="shape-fill"/><path d="M0 0V15.81C13 36.92 27.64 56.86 47.69 72.05 99.41 111.27 165 111 224.58 91.58c31.15-10.15 60.09-26.07 89.67-39.8 40.92-19 84.73-46 130.83-49.67 36.26-2.85 70.9 9.42 98.6 31.56 31.77 25.39 62.32 62 103.63 73 40.44 10.79 81.35-6.69 119.13-24.28s75.16-39 116.92-43.05c59.73-5.85 113.28 22.88 168.9 38.84 30.2 8.66 59 6.17 87.09-7.5 22.43-10.89 48-26.93 60.65-49.24V0z" opacity=".5" class="shape-fill"/><path d="M0 0V5.63C149.93 59 314.09 71.32 475.83 42.57c43-7.64 84.23-20.12 127.61-26.46 59-8.63 112.48 12.24 165.56 35.4C827.93 77.22 886 95.24 951.2 90c86.53-7 172.46-45.71 248.8-84.81V0z" class="shape-fill"/></svg></div></nav></header><main><div class=title-hero><h1>Automap API Operation Handlers in Components-Based Project</h1><div class=article-meta><div class=normal:justify-self-end>25 Oct 2020
(upd: 28 Oct 2020)</div><div class="hidden normal:block">&nbsp;—&nbsp;</div><div class="relative normal:justify-self-start"><svg class="inline relative" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg><span>&nbsp;2&nbsp;mins</span></div></div></div><article><p><a href=https://github.com/goldbergyoni/nodebestpractices class=external>Node.js best practices repo</a> is the most comprehensive list of style guides and architectural tips for Node.js apps I&rsquo;ve seen. The very first of them is about <a href=https://github.com/goldbergyoni/nodebestpractices/blob/master/sections/projectstructre/breakintcomponents.md class=external>structuring projects based on components instead of layers</a>.</p><p>For example, the typical layers-based layout would be:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>.
├── common
│   └── utils.ts
├── routers
│   ├── locations.router.ts
│   └── users.router.ts
├── services
│   ├── locations.service.ts
│   └── users.service.ts
└── index.ts
</code></pre></div><p>In comparison, this is a components-based layout:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>.
├── common
│   └── utils.ts
├── components
│   ├── locations
│   │   ├── locations.router.ts
│   │   └── locations.service.ts
│   └── users
│       ├── users.router.ts
│       └── users.service.ts
└── index.ts
</code></pre></div><p>When it comes to API design, the design-first approach is the most recommended: write the OpenAPI description document (or in any other format), then write the implementation code. Usually, you&rsquo;d want to leverage the description doc as much as possible to automate routine stuff, like request/response validation and operation handlers automapping.</p><p>For these purposes I use <a href=https://github.com/cdimascio/express-openapi-validator/ class=external><code>express-openapi-validator</code></a> package. The default behavior for automapping is:</p><ul><li>grab all files sitting directly under base directory (set on <code>OpenApiValidator</code> middleware options)</li><li>check files with names equal to <code>x-eov-operation-handler</code> from the description doc</li><li>search files for exported functions with the names equal to either <code>operationId</code> or <code>x-eov-operation-id</code></li></ul><p>This behavior isn&rsquo;t compatible with the components-base layout, since there is no such thing as base directory: each handler lives in the separate directory. Fortunately, you can customize default behavior with <a href=https://github.com/cdimascio/express-openapi-validator/#%EF%B8%8F-operationhandlers-optional class=external>custom resolver</a>!</p><p>For example, custom resolver I wrote:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js>operationHandlers<span style=color:#ff79c6>:</span> {
    basePath<span style=color:#ff79c6>:</span> path.join(__dirname, <span style=color:#f1fa8c>&#39;components&#39;</span>),
    resolver<span style=color:#ff79c6>:</span> (basePath<span style=color:#ff79c6>:</span> string, route, apiDoc) =&gt; {
        <span style=color:#ff79c6>const</span> pathKey <span style=color:#ff79c6>=</span> route.openApiRoute.substring(route.basePath.length);
        <span style=color:#ff79c6>const</span> schema <span style=color:#ff79c6>=</span> apiDoc.paths[pathKey][route.method.toLowerCase()];
        <span style=color:#ff79c6>const</span> functionName <span style=color:#ff79c6>=</span> schema[<span style=color:#f1fa8c>&#39;operationId&#39;</span>];
        <span style=color:#ff79c6>const</span> [componentName, routerName] <span style=color:#ff79c6>=</span> schema[<span style=color:#f1fa8c>&#39;x-eov-operation-handler&#39;</span>].split(<span style=color:#f1fa8c>&#39;.&#39;</span>);
        <span style=color:#ff79c6>const</span> routerPath <span style=color:#ff79c6>=</span> routerName <span style=color:#ff79c6>?</span> <span style=color:#f1fa8c>`</span><span style=color:#f1fa8c>${</span>routerName<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>.router`</span> <span style=color:#ff79c6>:</span> <span style=color:#f1fa8c>`</span><span style=color:#f1fa8c>${</span>componentName<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>.router`</span>;
        <span style=color:#ff79c6>const</span> modulePath <span style=color:#ff79c6>=</span> path.join(basePath, componentName, routerPath);
        <span style=color:#ff79c6>const</span> handler <span style=color:#ff79c6>=</span> require(modulePath);
        <span style=color:#ff79c6>if</span> (handler[functionName] <span style=color:#ff79c6>===</span> <span style=color:#ff79c6>undefined</span>) {
            <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> <span style=color:#8be9fd;font-style:italic>Error</span>(<span style=color:#f1fa8c>`Could not find a [</span><span style=color:#f1fa8c>${</span>functionName<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>] function in </span><span style=color:#f1fa8c>${</span>modulePath<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c> when trying to route [</span><span style=color:#f1fa8c>${</span>route.method<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c> </span><span style=color:#f1fa8c>${</span>route.expressRoute<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>].`</span>);
        }
        <span style=color:#ff79c6>return</span> handler[functionName];
    }
}
</code></pre></div><div class="admonition warning"><div class=admonition-icon><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg></div><p>The code was updated after the fix <a href=https://github.com/cdimascio/express-openapi-validator/issues/426 class=external>#426</a>. Should be a valid example as of version v4.3.6.</p></div><p>It assumes several things about the project&rsquo;s structure:</p><ul><li>All handlers are in the <code>components/{componentName}</code> directories.</li><li>All handlers have <code>.router</code> postfix in the filename</li><li>There could be several handlers inside component.</li><li>Default handler should have the same name as the component.</li><li><code>x-eov-operation-handler</code> is equal to either component name (default handler) or <code>{componentName}.{handler}</code>.</li></ul><p>Why so many assumptions? First, I wanted it simple. Second, I avoided introducing libraries for glob file search (yes, Node.js doesn&rsquo;t have globs in standard library, bleh). And third, it will be fairly easy to change anyway!</p></article><div class=page-navigation><a class=prev href=https://www.aviskase.com/articles/2020/10/18/blog-redesign-phase-1/ title="Blog Redesign: Phase 1"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 17l-5-5 5-5m7 10-5-5 5-5"/></svg>older</a>
<span class=separator>&nbsp; &#183; &nbsp; &#183; &nbsp; &#183; &nbsp;</span>
<a class=next href=https://www.aviskase.com/articles/2020/11/03/hmms-october/ title="Hmms: October">newer<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 17l5-5-5-5M6 17l5-5-5-5"/></svg></a></div></main><footer class="justify-center flex w-full py-4 text-16"><a class="border-b-2 border-transparent hover:border-primary" href=mailto:aviskase@gmail.com>Yuliya Bagriy</a><span> &#183; 2020 &#183; </span><a class="border-b-2 border-transparent hover:border-primary" href=https://www.aviskase.com/pages/i-dont-track-you/>No tracking</a></footer></div></body></html>