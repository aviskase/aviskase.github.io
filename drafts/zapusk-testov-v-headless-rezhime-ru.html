<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# profile: http://ogp.me/ns/profile#">

    <head>

        <title>Запуск тестов в headless режиме | aviskase</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta charset="utf-8" />





<meta name="description" content="Это баян, все это знают, но а вдруг забуду? Коротенько о том, что питон прелестен и аве плагино-писателям. Болтовня Поставила Jenkins как белый человек нативно, а не war. И тут-то оказалось, что запустить Selenium тесты просто так не выйдет. Видите-ли при установке Jenkins создал себе собственного юзверя и выполняет задачки …"/>

        <link href="https://www.aviskase.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="aviskase Full Atom Feed" />

        <link rel="icon" href="https://www.aviskase.com/theme/favicon.ico">
        <link rel="stylesheet" href="//code.cdn.mozilla.net/fonts/fira.css">
        <link rel="stylesheet" type="text/css" href="https://www.aviskase.com/theme/css/fontello.css" />
        <link rel="stylesheet" type="text/css" href="https://www.aviskase.com/theme/style.css" />
        <link rel="stylesheet" type="text/css" href="https://www.aviskase.com/theme/solarized-light.css" />

<script type="text/javascript">
    var disqus_identifier = "drafts/zapusk-testov-v-headless-rezhime-ru.html";
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'https://aviskase.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js" data-cfasync="false"></script>
  <script>
  if(!(window.doNotTrack === "1" || navigator.doNotTrack === "1" || navigator.doNotTrack === "yes" || navigator.msDoNotTrack === "1")) {
    window.addEventListener("load", function(){
      function enableCookies() {
          window.dataLayer = window.dataLayer || [];
            window.dataLayer.push({
              'pageType': 'article',
              'articleCategory': 'misc',
              'articleTags': []
            });

          (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-W75RR8K');
      }

      function handleStatus(status) {
        if ('allow' === status) {
          enableCookies();
        }
      }
      window.cookieconsent.hasTransition = false;

      window.cookieconsent.initialise({
        palette: {
          popup: {background: "#000000"},
          button: {background: 'transparent', border: "#d47500"},
          highlight: {background: 'transparent', border: '#008000'}
        },
        type: "opt-in",
        content: {
          message: "This site uses cookies for analytics.",
          href: 'https://www.aviskase.com/pages/privacy-and-cookies',
        },
        onInitialise: handleStatus,
        onStatusChange: handleStatus
      })
    });
  }
  </script>    </head>

<body id="index" class="home">
    <nav>
        <ul>
          <li><a class="site-title" href="https://www.aviskase.com/">aviskase</a></li>
          <li><a class="site-title" href="https://www.aviskase.com/">Blog</a></li>

          <li><a href="https://www.aviskase.com/pages/about">About</a></li>
          <li><a href="https://www.aviskase.com/meta">Meta</a></li>
          <li><a href="https://www.aviskase.com/feeds/all.atom.xml">RSS</a></li>

        </ul>

    </nav>

    <main>
<article>

    <h1>Запуск тестов в headless&nbsp;режиме</h1>

    <div class='article-meta'>

        <time class="published">4 Nov 2015</time>


        <span class="readtime">
            <span class='icon-clock' aria-hidden="true"></span>
            1&nbsp;min
        </span>

        <span class="article-category">
            <span class="icon-folder-open" aria-hidden="true"></span>
            <a href="https://www.aviskase.com/category/misc/">misc</a>
        </span>



        <span class="article-comments">
            <span class='icon-chat-empty' aria-hidden="true"></span>
            <a href="https://www.aviskase.com/drafts/zapusk-testov-v-headless-rezhime-ru.html#disqus_thread" data-disqus-identifier="">0 comments</a>
        </span>

    </div>


    <p>Это баян, все это знают, но а вдруг&nbsp;забуду?</p>
<p>Коротенько о том, что питон прелестен и аве&nbsp;плагино-писателям.</p>
<h2>Болтовня</h2>
<p>Поставила Jenkins как белый человек нативно, а не war. И тут-то оказалось, что запустить Selenium тесты просто так не выйдет. Видите-ли при установке Jenkins создал себе собственного юзверя и выполняет задачки от его имени. А значит, если вы залогинены под собой, то этот пользователь не имеет доступа к гуям. Такие&nbsp;дела.</p>
<p>Поэтому нужно обеспечить ему доступ к виртуальным гуям. По сути есть два способа это сделать: <em>vncserver</em> либо <em>xvfb</em>. Здесь и далее речь идет о *nix, что там под Windows я не знаю, и не очень хочу выяснять, пока не&nbsp;припрет.</p>
<p>Честно, я не в курсе, что там за разница между этими двумя способами. Субъективно, <em>xvfb</em>&nbsp;быстрее.</p>
<h2>Установка</h2>
<p>Команды приведены для debian-like&nbsp;дистрибутивов.</p>
<h3>Vncserver</h3>
<p>Ставим, настраиваем. В процессе попросит поставить пароль для vnc сервера &mdash; пишем что угодно, он нам не&nbsp;понадобится.</p>
<div class="highlight"><pre><span></span><code>$ sudo apt-get install -y vnc4server
$ sudo su jenkins
$ vncserver
$ <span class="nb">exit</span>
</code></pre></div>

<h3>Xvfb</h3>
<p>Все просто, ставим и радуемся. Поговаривают, что там еще какие-то шрифты нужно установить. Я не ставила, но тебя, заблудший сюда, если что предупредили&nbsp;=)</p>
<div class="highlight"><pre><span></span><code>$ sudo apt-get install xvfb
</code></pre></div>

<h2>Как&nbsp;запускать</h2>
<h3>Python</h3>
<p>Существует библиотека <a class="external" href="https://pypi.python.org/pypi/PyVirtualDisplay">PyVirtualDisplay</a>. Это обертка вокруг этих наших виртуальных дисплеев. Нет смысла сособо ее описывать, доки очень понятные. Приведу лишь пример кода в&nbsp;тесте:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">selenium</span> <span class="kn">import</span> <span class="n">webdriver</span>
<span class="kn">from</span> <span class="nn">pyvirtualdisplay</span> <span class="kn">import</span> <span class="n">Display</span>
<span class="n">display</span> <span class="o">=</span> <span class="n">Display</span><span class="p">(</span><span class="n">visible</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">800</span><span class="p">,</span> <span class="mi">600</span><span class="p">))</span>
<span class="n">display</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="n">driver</span> <span class="o">=</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">Firefox</span><span class="p">()</span>
<span class="c1"># tests</span>
<span class="n">driver</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
<span class="n">display</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</code></pre></div>

<p>Этот способ хорош тем, что не зависит от того, где будут запускаться тесты. Есть Jenkins, нет его, какой конкретно X установлен &mdash; не нужно&nbsp;заморачиваться.</p>
<h3>Java</h3>
<p>Умные люди говорят, что таких замечательных библиотек для джавы нема. У меня тоже найти не получилось. Поэтому скажем спасибо хорошим людям, которые написали плагины для&nbsp;Jenkins.</p>
<p>Если запускать через vncserver, то нужно установить плагин <code>xvnc</code>. Если через xvfb &mdash; то <code>xvfb</code>.</p>
<p>И теперь при конфигурации джобов нужно все-лишь поставить галочку  &ldquo;Run xvnc / xvfb during build&rdquo; в разделе &ldquo;Build Environment&rdquo;. Вроде&nbsp;все.</p>
<p>С одной стороны, этот способ хорош тем, что метод запуска отделен от логики тестов. С другой стороны, если мы захотим прогнать эти же самые тесты на локальной машине, то все равно придется городить зависимости от maven плагинов (да, они&nbsp;существуют).</p>
<h2><span class="caps">P.S.</span></h2>
<p>Ну да, знаю, есть же еще PhantomJS. Готовый headless браузер. Замечательная штука, но он не смог переварить прелестный код мой текущего проекта и отказывается грузить половину элементов. Поэтому play-safe, лучше пусть будет тормознее, но с реальными&nbsp;браузерами.</p>
<p>Кстати. Headless. А как по-русски? Мне на ум приходит только&nbsp;&ldquo;безбашенный&rdquo;.</p>



    <div class="page-navigation code">


    </div>

<div id="disqus_thread"></div>
</article>
    </main>

    <footer>
        <a href="mailto:aviskase@gmail.com">Yuliya Bagriy</a><span> &middot; 2020 &middot; </span><a href="https://www.aviskase.com/pages/privacy-and-cookies">Privacy</a>
    </footer>

    <script id="dsq-count-scr" src="//aviskase.disqus.com/count.js" async></script>

</body>
</html>